<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CFC NFT Creator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        margin: 0;
        background: #000;
        font-family: Arial, sans-serif;
    }

    .outer {
        padding: 40px 0;
        display: flex;
        justify-content: center;
    }

    .container {
        width: 90%;
        max-width: 700px;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
    }

    h1 {
        text-align: center;
        color: #000;
        margin-bottom: 20px;
    }

    label {
        font-weight: bold;
        margin-top: 15px;
        display: block;
    }

    input, textarea, select {
        width: 100%;
        padding: 12px;
        margin-top: 6px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
    }

    button {
        width: 100%;
        padding: 15px;
        margin-top: 25px;
        background: #111;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        cursor: pointer;
    }

    button:hover {
        background: #333;
    }

    .disabled {
        background: #777 !important;
        cursor: not-allowed !important;
    }

    .section-title {
        margin-top: 30px;
        font-size: 18px;
        font-weight: bold;
        color: #000;
    }

    .info-box {
        background: #f2f2f2;
        padding: 15px;
        margin-top: 25px;
        border-radius: 8px;
        font-size: 15px;
        line-height: 1.5;
    }

    .success {
        background: #e6ffe6;
        border-left: 4px solid #2ca02c;
        padding: 10px;
        margin-top: 20px;
    }

    .error {
        background: #ffe6e6;
        border-left: 4px solid #cc0000;
        padding: 10px;
        margin-top: 20px;
    }
</style>

</head>
<body>

<div class="outer">
<div class="container">

<h1>Create Your NFT</h1>

<!-- WALLET CONNECT -->
<button id="connectBtn" onclick="connectWallet()">Connect Xaman Wallet</button>

<div id="walletBox" style="margin-top:15px; font-size:16px;"></div>

<!-- NFT FORM -->
<label>Upload File (image, video, PDF)</label>
<input type="file" id="fileInput">

<label>NFT Name</label>
<input type="text" id="nftName" placeholder="Example: Executive Strategy Session">

<label>Description</label>
<textarea id="nftDescription" rows="4" placeholder="Describe your NFT..."></textarea>

<label>Quantity (1–100)</label>
<input type="number" id="quantity" value="1" min="1" max="100">

<label>Price (XRP)</label>
<input type="number" id="priceXRP" value="10" min="1">

<label>Price (RLUSD)</label>
<input type="number" id="priceRLUSD" value="25">

<label>Royalty (fixed)</label>
<input type="text" value="5% (standard)" disabled>

<button id="submitBtn" onclick="submitNFT()">Submit NFT for Approval</button>

<!-- PAYMENT BUTTON (disabled until approved) -->
<button id="payBtn" class="disabled" disabled>Pay & Mint NFT</button>

<div id="result"></div>

<div class="info-box">
    <strong>NFT Creation Process</strong><br><br>
    1️⃣ Connect your Xaman wallet.<br>
    2️⃣ Upload your file and enter NFT details.<br>
    3️⃣ Submit your NFT for approval (allow up to 24 hours).<br>
    4️⃣ After approval, return to this page and reconnect wallet.<br>
    5️⃣ Your payment button will unlock automatically.<br>
    6️⃣ Once paid, your NFT is minted to your wallet.<br><br>
    Fields lock after approval to prevent changes.<br>
    Royalty fixed at 5%.
</div>

</div>
</div>

<script>
const BACKEND = "https://cfc-nft-creator-backend.onrender.com";
const XUMM_API_KEY = "eebd4c17-c3ef-435b-b891-89afb99e259e";

let userWallet = "";
let submissionId = null;
let approved = false;

// --------------------
// WALLET CONNECT
// --------------------
async function connectWallet() {
    const payload = {
        txjson: { TransactionType: "SignIn" }
    };

    const res = await fetch("https://xumm.app/api/v1/platform/payload", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-API-Key": XUMM_API_KEY
        },
        body: JSON.stringify(payload)
    });

    const data = await res.json();

    window.open(data.next.always, "_blank");

    checkPayload(data.uuid);
}

async function checkPayload(uuid) {
    let interval = setInterval(async () => {
        const res = await fetch("https://xumm.app/api/v1/platform/payload/" + uuid, {
            headers: { "X-API-Key": XUMM_API_KEY }
        });

        const data = await res.json();

        if (data.signed === true) {
            clearInterval(interval);

            userWallet = data.response.account;
            document.getElementById("walletBox").innerHTML =
                "Connected Wallet: <strong>" + userWallet + "</strong>";

            checkApprovalStatus();
        }
    }, 2000);
}

// --------------------
// CHECK APPROVAL STATUS
// --------------------
async function checkApprovalStatus() {
    const res = await fetch(BACKEND + "/api/admin/submissions?password=CFCBaby3!");
    const items = await res.json();

    const found = items.find(x => x.creator_wallet === userWallet);

    if (!found) return;

    submissionId = found.id;

    if (found.status === "approved") {
        approved = true;
        lockForm();
        enablePayment();
    }
}

// --------------------
// LOCK FIELDS AFTER APPROVAL
// --------------------
function lockForm() {
    document.getElementById("fileInput").disabled = true;
    document.getElementById("nftName").disabled = true;
    document.getElementById("nftDescription").disabled = true;
    document.getElementById("quantity").disabled = true;
    document.getElementById("priceXRP").disabled = true;
    document.getElementById("priceRLUSD").disabled = true;
    document.getElementById("submitBtn").classList.add("disabled");
    document.getElementById("submitBtn").disabled = true;
}

// --------------------
// ENABLE PAYMENT BUTTON
// --------------------
function enablePayment() {
    const btn = document.getElementById("payBtn");
    btn.classList.remove("disabled");
    btn.disabled = false;
    btn.onclick = () => payNow();
}

// --------------------
// SUBMIT FOR APPROVAL
// --------------------
async function submitNFT() {
    const file = document.getElementById("fileInput").files[0];
    const name = document.getElementById("nftName").value;
    const description = document.getElementById("nftDescription").value;
    const quantity = document.getElementById("quantity").value;
    const priceXRP = document.getElementById("priceXRP").value;
    const priceRLUSD = document.getElementById("priceRLUSD").value;

    if (!userWallet) {
        alert("Connect wallet first.");
        return;
    }

    if (!file || !name || !description) {
        alert("Fill all fields.");
        return;
    }

    // Upload file
    const fd = new FormData();
    fd.append("file", file);

    const uploadRes = await fetch(BACKEND + "/api/upload", {
        method: "POST",
        body: fd
    });
    const uploadData = await uploadRes.json();
    const imageCid = uploadData.cid;

    // Upload metadata
    const metadata = {
        name,
        description,
        priceXRP,
        priceRLUSD,
        quantity,
        image: "ipfs://" + imageCid,
        royalty: "5%",
        creator_wallet: userWallet
    };

    const fd2 = new FormData();
    fd2.append("file",
        new Blob([JSON.stringify(metadata)], { type: "application/json" }),
        "metadata.json"
    );

    const mdRes = await fetch(BACKEND + "/api/upload", {
        method: "POST",
        body: fd2
    });
    const md = await mdRes.json();

    // Submit record
    await fetch(BACKEND + "/api/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            wallet: userWallet,
            name,
            description,
            imageCid,
            metadataCid: md.cid,
            quantity
        })
    });

    document.getElementById("result").innerHTML =
        `<div class="success">NFT submitted for approval. Please allow up to 24 hours.</div>`;
}

// --------------------
// PAYMENT
// --------------------
async function payNow() {
    const payload = {
        txjson: {
            TransactionType: "Payment",
            Destination: userWallet,
            Amount: "5000000"   // 5 XRP
        }
    };

    const res = await fetch("https://xumm.app/api/v1/platform/payload", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-API-Key": XUMM_API_KEY
        },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    window.open(data.next.always, "_blank");

    // Mint will occur automatically via your admin dashboard
}
</script>

</body>
</html>
