<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CFC Admin Dashboard (Auto Mint Enabled)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    html { background: #fff; }
    body {
        font-family: Arial, sans-serif;
        background: #fff;
        margin: 0;
        padding: 30px;
    }
    .box {
        max-width: 1400px;
        margin: auto;
        background: #fff;
        border-radius: 12px;
        padding: 30px;
    }
    h1 { text-align: center; margin-bottom: 25px; }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 30px;
        font-size: 15px;
    }
    th, td {
        padding: 12px;
        border-bottom: 1px solid #ccc;
        vertical-align: top;
    }
    th {
        background: #eee;
        text-align: left;
        font-weight: bold;
    }
    .action-btn {
        padding: 6px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 6px;
    }
    .approve { background: #28a745; color: #fff; }
    .reject  { background: #dc3545; color: #fff; }
    .preview-img { max-width: 140px; border-radius: 6px; }

    .paid { color:#007BFF; font-weight:bold; }
    .minted { color:#28A45; font-weight:bold; }
    .pending { color:#FFC107; font-weight:bold; }
    .approved { color:#17A2B8; font-weight:bold; }
    .rejected { color:#dc3545; font-weight:bold; }

    .text-ellipsis {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        white-space: pre-line;
    }
    .text-expanded {
        display: block;
        white-space: pre-line;
    }
    .toggle-link {
        color: #007BFF;
        font-size: 13px;
        cursor: pointer;
        margin-top: 4px;
        display: inline-block;
    }
</style>
</head>

<body>

<div class="box">
<h1>CFC NFT Creator — Admin Dashboard</h1>
    <!-- ===============================
     LEARN-TO-EARN ACTIVITY (NEW)
     ADD-ONLY / NO REGRESSIONS
================================ -->

<h2 style="margin-top:50px;">Learn-to-Earn Activity</h2>

<table id="learnTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Wallet</th>
      <th>Submission ID</th>
      <th>Action</th>
      <th>Reference</th>
      <th>Earned</th>
      <th>Paid</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<table id="subTable">
<thead>
<tr>
    <th>ID</th>
    <th>Preview</th>
    <th>Name</th>
    <th>Description</th>
    <th>Terms</th>
    <th>Qty</th>
    <th>Price XRP</th>
    <th>Price RLUSD</th>
    <th>Wallet</th>
    <th>Email</th>
    <th>Website</th>
    <th>Status</th>
    <th>Payment</th>
    <th>Mint</th>
    <th>Redeem</th>
    <th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const BACKEND = "https://cfc-nft-creator-backend.onrender.com";
const ADMIN_PASSWORD = "CFCBaby3!";

async function fetchMetadata(cid) {
    try {
        const r = await fetch("https://gateway.pinata.cloud/ipfs/" + cid);
        return await r.json();
    } catch {
        return null;
    }
}

function buildCollapsible(text) {
    return `
      <div class="text-ellipsis">${text}</div>
      <div class="text-expanded" style="display:none;">${text}</div>
      <span class="toggle-link" onclick="toggleReadMore(this)">Read more</span>
    `;
}

async function loadSubmissions() {
    const res = await fetch(`${BACKEND}/api/admin/submissions?password=${ADMIN_PASSWORD}`);
    const subs = await res.json();
    const tbody = document.querySelector("#subTable tbody");
    tbody.innerHTML = "";

    for (const s of subs) {
        const md = await fetchMetadata(s.metadata_cid);
// -------------------------------
// LEARN-TO-EARN (ADMIN VIEW)
// -------------------------------
if (md?.learn?.enabled) {
  html += `
    <div style="margin-top:10px;padding:10px;background:#f4f4f4;border-radius:6px;">
      <strong>Learn-to-Earn Content</strong><br>
      <pre style="white-space:pre-wrap;font-size:13px;margin-top:6px;">
${md.learn.content}
      </pre>
    </div>
  `;
}

        const mediaURL = "https://gateway.pinata.cloud/ipfs/" + s.image_cid;
        let preview = `<img src="${mediaURL}" class="preview-img">`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${preview}</td>
          <td>${md?.name || s.name}</td>
      <td>
  ${buildCollapsible(md?.description || s.description)}

  ${
    md?.learn?.enabled
      ? `
        <div style="margin-top:10px;padding:10px;background:#f4f4f4;border-radius:6px;">
          <strong>Learn-to-Earn Content</strong>
          <pre style="white-space:pre-wrap;font-size:13px;margin-top:6px;">
${md.learn.content}
          </pre>
        </div>
        `
      : ""
  }
</td>
          <td>${buildCollapsible(md?.terms || s.terms || "—")}</td>
          <td>${s.batch_qty}</td>
          <td>${md?.price_xrp || s.price_xrp || "—"}</td>
          <td>${md?.price_rlusd || s.price_rlusd || "—"}</td>
          <td>${s.creator_wallet}</td>
          <td>${s.email || "—"}</td>
          <td>${s.website ? `<a href="${s.website}" target="_blank">Visit</a>` : "—"}</td>
          <td class="${s.status}">${s.status}</td>
          <td class="${s.payment_status === "paid" ? "paid" : "pending"}">${s.payment_status}</td>
          <td class="${s.mint_status === "minted" ? "minted" : "pending"}">${s.mint_status}</td>
          <td>
            ${s.status === "REDEEM_REQUESTED"
              ? `<strong style="color:#dc3545">Redeem Requested</strong><br>Email: ${s.buyer_email || "—"}`
              : "—"}
          </td>
          <td>
            ${
              s.status === "pending"
              ? `
                <button class="action-btn approve" onclick="approve(${s.id})">Approve</button>
                <button class="action-btn reject" onclick="reject(${s.id})">Reject</button>
              `
              : s.status === "rejected"
                ? `<span class="rejected">❌ Rejected</span>`
                : ""
            }
          </td>
        `;
        tbody.appendChild(tr);
    }
}

function toggleReadMore(el) {
    const box = el.parentElement;
    const collapsed = box.querySelector(".text-ellipsis");
    const expanded = box.querySelector(".text-expanded");

    if (expanded.style.display === "none") {
        collapsed.style.display = "none";
        expanded.style.display = "block";
        el.textContent = "See less";
    } else {
        collapsed.style.display = "-webkit-box";
        expanded.style.display = "none";
        el.textContent = "Read more";
    }
}

async function approve(id) {
    await fetch(`${BACKEND}/api/admin/approve`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ id, password: ADMIN_PASSWORD })
    });
    loadSubmissions();
}

async function reject(id) {
    const reason = "Rejected by admin (details will be emailed).";

    await fetch(`${BACKEND}/api/admin/reject`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ id, password: ADMIN_PASSWORD, reason })
    });

    loadSubmissions();
}

// ===============================
// LEARN-TO-EARN ADMIN LOAD (NEW)
// ===============================
async function loadLearnActivity() {
    const res = await fetch(
        `${BACKEND}/api/admin/learn-activity?password=${ADMIN_PASSWORD}`
    );

    if (!res.ok) return;

    const rows = await res.json();
    const tbody = document.querySelector("#learnTable tbody");
    if (!tbody) return;

    tbody.innerHTML = "";

    for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.wallet}</td>
            <td>${r.submission_id}</td>
            <td>${r.action_type}</td>
            <td>${r.action_ref}</td>
            <td>${r.tokens_earned}</td>
            <td>${r.tokens_paid}</td>
            <td>${new Date(r.created_at).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    }
}

loadLearnActivity();
    loadSubmissions();

</script>

<script>
function sendHeight() {
    window.parent.postMessage({ cfcHeight: document.body.scrollHeight }, "*");
}
setInterval(sendHeight, 500);
window.onload = sendHeight;
</script>

</body>
</html>
